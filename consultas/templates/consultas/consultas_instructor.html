{% extends layout %}

{% block content %}

  {% comment %}Mostrar esto solo al funcionario{% endcomment %}
  {% if rol == 3 %}
    <!-- Secci√≥n principal - Consultar Fichas -->
    <main class="contenido-principal">
      {% if messages %}
        {% for message in messages %}
          <div class="alert"
            style="padding: 12px; margin: 15px 0; border-radius: 6px; font-size: 14px; border: 1px solid;
            {% if message.tags == 'success' %}
              background-color: #d4edda; color: #155724; border-color: #c3e6cb;
            {% elif message.tags == 'error' %}
              background-color: #f8d7da; color: #721c24; border-color: #f5c6cb;
            {% else %}
              background-color: #d1ecf1; color: #0c5460; border-color: #bee5eb;
            {% endif %}">{{ message }}</div>
        {% endfor %}
      {% endif %}

      <!-- T√≠tulo de la secci√≥n -->
      <div class="titulo-seccion">
        <h2 class="titulo-pagina">Consultar solicitudes {{ user }} {{ user_name }}</h2>
        <p class="subtitulo-pagina">Aqu√≠ puede consultar el estado de las fichas solicitadas y descargar los documentos correspondientes</p>
      </div>

      <!-- busqueda y filtro -->
      <!-- filtro por nombre de programa -->
      <div class="filtros-busqueda">
        <div class="filtro-nombre-programa">
          <label for="filtro-programa-funcionario">Filtrar por Nombre de Programa:</label>
          <input type="text" id="filtro-programa-funcionario" placeholder="Ingrese el nombre del programa" onkeyup="filtrarPorProgramaFuncionario()" />
        </div>
        <!-- filtro si es regular o campesena -->
        <div class="filtro-tipo-ficha">
          <label for="filtro-tipo-funcionario">Filtrar por Tipo de Ficha:</label>
          <select id="filtro-tipo-funcionario" onchange="filtrarPorTipoFuncionario()">
            <option value="">-- Todos --</option>
            <option value="Regular">Regular</option>
            <option value="Campesina">CampeSENA</option>
          </select>
        </div>
        <!-- filtro por fecha -->
        <div class="filtro-fecha">
          <label for="filtro-fecha">Filtrar por Fecha:</label>
          <input type="date" id="filtro-fecha" />
        </div>
      </div>

      <!-- Contenedor de la tabla de fichas -->
      <div class="contenedor-tabla-fichas">
        <table class="tabla-fichas">
          <thead>
            <tr>
              <th>Nombre del Programa</th>
              <th>Revisi√≥n realizada por</th>
              <th>Descargas</th>
              <th>Fecha Creaci√≥n</th>
              <th>Estado</th>
              <th>C√≥digo de la ficha</th>
              <th>C√≥digo de solicitud</th>
              <th>Observaci√≥n</th>
              <th>Enviar</th>
            </tr>
          </thead>
          <tbody>
            {% for solicitud_consulta in solicitudes %}
              <tr data-fecha="{{ solicitud_consulta.fechasolicitud|date:'Y-m-d' }}">
                <form action="{% url 'ficha_funcionario' solicitud_consulta.idsolicitud %}" method="POST" enctype="multipart/form-data" style="display: contents;">
                  {% csrf_token %}

                  <!-- Programa -->
                  <td>{{ solicitud_consulta.codigoprograma.nombreprograma }}</td>

                  <!-- Nombre visible y rol -->
                  <td>
                    {% if solicitud_consulta.visible_nombre %}
                      {{ solicitud_consulta.visible_nombre }}
                    {% comment %} {% else %}
                      Sin revisi√≥n a√∫n {% endcomment %}
                    {% endif %}
                  </td>

                  <!-- Descargas -->
                  <td style="min-height: 150px; vertical-align: top; padding: 10px;">
                    <div style="display: flex; flex-direction: column; gap: 8px;">
                      <a href="{% url 'ficha_caracterizacion_pdf' solicitud_consulta.idsolicitud %}" class="boton-descargar" style="padding: 6px 10px; font-size: 12px;">Ficha de caracterizaci√≥n</a>
                      <a href="{% url 'descargar_pdf' solicitud_consulta.idsolicitud rol %}" class="boton-descargar" style="padding: 6px 10px; font-size: 12px;">Documentos aspirantes</a>
                      {% if solicitud_consulta.boton_ver_carta_disabled %}
                        <button class="boton-descargar" disabled style="padding: 6px 10px; font-size: 12px;">Ver Carta (No disponible)</button>
                      {% elif solicitud_consulta.mostrar_boton_carta_funcionario %}
                        <a href="{% url 'descargar_carta' solicitud_consulta.idsolicitud rol %}" class="boton-descargar" style="padding: 6px 10px; font-size: 12px;">Carta de solicitud</a>
                      {% else %}
                        <a href="{% url 'descargar_carta' solicitud_consulta.idsolicitud rol %}" class="boton-descargar" style="padding: 6px 10px; font-size: 12px;">Carta de solicitud</a>
                      {% endif %}
                      {% if solicitud_consulta.excel_funcionario_disponible %}
                        <a href="{% url 'descargar_excel' solicitud_consulta.idsolicitud rol %}"
                          class="link-excel boton-descargar" data-id="{{ solicitud_consulta.idsolicitud }}" style="padding: 6px 10px; font-size: 12px;">Formato inscripci√≥n masivo</a>
                        <div class="subida-reemplazo" data-id="{{ solicitud_consulta.idsolicitud }}" style="display: none;">
                          <input type="file" class="archivo-subida" name="actualizar_excel" id="actualizar_excel_{{ solicitud_consulta.idsolicitud }}" data-id="{{ solicitud_consulta.idsolicitud }}" />
                        </div>
                      {% else %}
                        <a class="link-excel boton-descargar disabled-link" data-id="{{ solicitud_consulta.idsolicitud }}" tabindex="-1" aria-disabled="true" style="padding: 6px 10px; font-size: 12px;">Formato inscripci√≥n masivo</a>
                      {% endif %}
                    </div>
                  </td>

                  <!-- Fecha solicitud -->
                  <td>{{ solicitud_consulta.fechasolicitud }}</td>

                  <!-- Estado -->
                  <td>
                    <select name="estado" id="estado_{{ solicitud_consulta.idsolicitud }}">
                      <option value="">-- Seleccione un estado --</option>
                      {% for item in estado %}
                        <option value="{{ item.idestado }}"
                          {% if solicitud_consulta.estado_usuario == item.estados %}
                            selected
                          {% endif %}
                        >
                          {{ item.estados }}
                        </option>
                      {% endfor %}
                    </select>
                  </td>

                  <!-- C√≥digo ficha -->
                  <td>
                    <input type="text" id="codigo_ficha_{{ solicitud_consulta.idsolicitud }}" name="codigo_ficha" class="entrada-texto"
                          value="{{ solicitud_consulta.codigo_ficha}}"
                          placeholder="C√≥digo de la ficha"
                          {% if solicitud_consulta.codigo_ficha %}readonly{% endif %}
                          />
                  </td>

                  <!-- C√≥digo solicitud -->
                  <td>
                    <input type="text" id="codigo_solicitud_{{ solicitud_consulta.idsolicitud }}" name="codigo_solicitud" class="entrada-texto" placeholder="C√≥digo de solicitud"/>
                  </td>
                  <!-- Observaci√≥n -->
                  <td>
                    <textarea name="observacion" class="entrada-texto">{{ solicitud_consulta.observacion_usuario }}</textarea>
                  </td>

                  <!-- Bot√≥n enviar -->
                  <td>
                    {% if solicitud_consulta.estado_usuario == "Matriculada" %}
                      <button type="submit" class="boton-enviar disabled" disabled>Enviar</button>
                    {% else %}
                      <button type="submit" class="boton-enviar">Enviar</button>
                    {% endif %}
                  </td>
                </form>

              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </main>

    <!-- JS SOLO PARA FUNCIONARIO -->
    <!-- JS SOLO PARA FUNCIONARIO -->
    <script>
      // Funci√≥n para mostrar alerta si el Excel no est√° disponible
      document.addEventListener('DOMContentLoaded', function () {
        document.querySelectorAll('.link-excel').forEach((enlace) => {
          // Si est√° deshabilitado, no aplicar la l√≥gica de reemplazo
          if (enlace.classList.contains('disabled-link')) return
          // Obtener el ID √∫nico del enlace
          const id = enlace.dataset.id
          // Seleccionar los elementos relacionados
          const subida = document.querySelector(`.subida-reemplazo[data-id="${id}"]`)
          const inputArchivo = document.querySelector(`.archivo-subida[data-id="${id}"]`)

          // Revisamos el estado guardado en localStorage
          const estado = localStorage.getItem('estadoExcel_' + id)

          // Mostrar/ocultar elementos seg√∫n el estado
          if (estado === 'descargado') {
            enlace.style.display = 'none'
            subida.style.display = 'block'
          } else {
            enlace.style.display = 'block'
            subida.style.display = 'none'
          }

          // Cuando se hace clic en el enlace (DESCARGAR)
          enlace.addEventListener('click', function () {
            enlace.style.display = 'none'
            subida.style.display = 'block'
            localStorage.setItem('estadoExcel_' + id, 'descargado')
          })

          // Cuando se sube un archivo (CAMBIAR)
          inputArchivo.addEventListener('change', function () {
            enlace.style.display = 'block'
            subida.style.display = 'none'
            localStorage.setItem('estadoExcel_' + id, 'subido')
          })
        })
      })

      // Funciones de filtrado para funcionarios
      function aplicarFiltrosFuncionario() {
        // Obtener los valores de los filtros
        const filtroPrograma = document.getElementById('filtro-programa-funcionario').value.toLowerCase()
        const filtroTipo = document.getElementById('filtro-tipo-funcionario').value
        const filtroFecha = document.getElementById('filtro-fecha').value // formato yyyy-mm-dd
        const filas = document.querySelectorAll('.tabla-fichas tbody tr')

        filas.forEach((fila) => {
          const programa = fila.cells[0].textContent.toLowerCase()
          // Obtener la fecha desde el atributo data-fecha
          const fecha = fila.getAttribute('data-fecha')
          // Obtener el tipo de solicitud desde los atributos data
          const tipoNombre = (fila.dataset.tiponombre || '').toLowerCase()
          const tipoId = fila.dataset.tipoid || ''
          // Determinar si es campesina o regular
          const esCampesina = tipoNombre === 'campesina' || tipoId === '2'
          const esRegular = tipoNombre === 'regular' || tipoId === '1'
          let mostrar = true

          // Programa
          if (filtroPrograma && !programa.includes(filtroPrograma)) mostrar = false
          // Tipo Regular/Campesina (se infiere del nombre del programa)
          if (filtroTipo) {
            if (filtroTipo === 'Regular' && !esRegular) mostrar = false
            if (filtroTipo === 'Campesina' && !esCampesina) mostrar = false
          }
          // Fecha exacta
          if (filtroFecha && fecha !== filtroFecha) mostrar = false

          fila.style.display = mostrar ? '' : 'none'
        })
      }

      function filtrarPorProgramaFuncionario() {
        aplicarFiltrosFuncionario()
      }
      function filtrarPorTipoFuncionario() {
        aplicarFiltrosFuncionario()
      }
      document.getElementById('filtro-fecha').addEventListener('change', aplicarFiltrosFuncionario)
    </script>
  {% elif rol == 2 %}
    {% comment %}Mostrar esto solo al Coordinador{% endcomment %}
    <main class="contenido-principal">
      {% if messages %}
        {% for message in messages %}
          <div class="alert"
            style="padding: 12px; margin: 15px 0; border-radius: 6px; font-size: 14px; border: 1px solid;
            {% if message.tags == 'success' %}
                background-color: #d4edda; color: #155724; border-color: #c3e6cb;
            {% elif message.tags == 'error' %}
                      background-color: #f8d7da; color: #721c24; border-color: #f5c6cb;
            {% else %}
                      background-color: #d1ecf1; color: #0c5460; border-color: #bee5eb;
            {% endif %}">{{ message }}</div>
        {% endfor %}
      {% endif %}

      <!-- T√≠tulo de la secci√≥n -->
      <div class="titulo-seccion">
        <h2 class="titulo-pagina">Consultar solicitudes {{ user }} {{ user_name }}</h2>
        <p class="subtitulo-pagina">Aqu√≠ puede consultar el estado de las fichas solicitadas y descargar los documentos correspondientes</p>
      </div>

      <!-- Filtros -->
      <div class="filtros-busqueda">
        <div class="filtro-nombre-programa">
          <label for="filtro-programa-coordinador">Filtrar por Nombre de Programa:</label>
          <input type="text" id="filtro-programa-coordinador" placeholder="Ingrese el nombre del programa" onkeyup="filtrarPorProgramaCoordinador()" />
        </div>
        <div class="filtro-tipo-ficha">
          <label for="filtro-tipo-coordinador">Filtrar por Tipo de Ficha:</label>
          <select id="filtro-tipo-coordinador" onchange="filtrarPorTipoCoordinador()">
            <option value="">-- Todos --</option>
            <option value="Regular">Regular</option>
            <option value="Campesina">CampeSENA</option>
          </select>
        </div>
        <div class="filtro-fecha">
          <label for="filtro-fecha-coord">Filtrar por Fecha:</label>
          <input type="date" id="filtro-fecha-coord" />
        </div>
      </div>

      <!-- Contenedor de la tabla -->
      <div class="contenedor-tabla-fichas">
        <table class="tabla-fichas">
          <thead>
            <tr>
              <th>Nombre del Programa</th>
              <th>Instructor solicitante</th>
              <th>Estado</th>
              <th>Ficha de Caracterizaci√≥n</th>
              <th>Documento aspirantes</th>
              <th>Carta de solicitud</th>
              <th>Formato inscripci√≥n masivo</th>
              <th>Fecha de Creaci√≥n</th>
              <th>Observaci√≥n de solicitud</th>
              <th>Compartir</th>
            </tr>
          </thead>
          <tbody>
            {% for solicitud_consulta in solicitudes %}
              <tr data-fecha="{{ solicitud_consulta.fechasolicitud|date:'Y-m-d' }}">
            <form action="{% url 'revision_coordinador' solicitud_consulta.idsolicitud %}" method="POST">
              {% csrf_token %}
              <!-- Nombre del programa -->
              <td>{{ solicitud_consulta.codigoprograma.nombreprograma }}</td>
              <!-- Nombre visible del usuario que revis√≥ o cre√≥ la solicitud -->
              <td>{{ solicitud_consulta.visible_nombre }}</td>
              <!-- Selecci√≥n de estado de la solicitud -->
              <td>
                <select name="estado">
                  <option value="">-- Seleccione un estado --</option>
                  {% for item in estado %}
                    <option value="{{ item.id }}"
                      {% if solicitud_consulta.estado_coordinador == item.estado %}
                        selected
                      {% endif %}>
                      {{ item.estado }}
                    </option>
                  {% endfor %}
                </select>
              </td>
              <!-- Enlaces para descargar/ver documentos relacionados con la solicitud -->
              <td>
                <a href="{% url 'ficha_caracterizacion' solicitud_consulta.idsolicitud %}" class="boton-descargar">Ver ficha de caracterizaci√≥n</a>
              </td>
              <td>
                <a href="{% url 'ver_pdf_aspirantes' solicitud_consulta.idsolicitud %}" class="boton-descargar">Ver documento aspirantes</a>
              </td>
              <td>
                {% if solicitud_consulta.boton_ver_carta_disabled %}
                  <a class="boton-descargar disabled" style="pointer-events: none; opacity: 0.5;"
                    title="No hay empresa asociada">Ver carta de solicitud</a>
                {% else %}
                  <a href="{% url 'ver_pdf_carta' solicitud_consulta.idsolicitud %}" class="boton-descargar">
                    Ver carta de solicitud
                  </a>
                {% endif %}
              </td>
              <td>
                <a href="{% url 'ver_formato' solicitud_consulta.idsolicitud %}" class="link-excel">Ver formato de inscripci√≥n masivo</a>
              </td>
              <!-- Fecha de la solicitud -->
              <td>{{ solicitud_consulta.fechasolicitud }}</td>
              <!-- Observaciones del coordinador -->
              <td>
          <textarea name="observacion" class="entrada-texto">{{ solicitud_consulta.observacion_coordinador|default_if_none:"" }}</textarea>
              </td>
              <!-- Bot√≥n de env√≠o; deshabilitado si la solicitud ya est√° aprobada -->
              <td>
                {% if solicitud_consulta.estado_coordinador == "Aprobado" %}
                  <button type="submit" class="disabled" disabled>Enviar</button>
                {% else %}
                  <button type="submit">Enviar</button>
                {% endif %}
              </td>
            </form>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </main>

    <script>
      // Funciones de filtrado para coordinadores
      function aplicarFiltrosCoordinador() {
        const filtroPrograma = document.getElementById('filtro-programa-coordinador').value.toLowerCase()
        const filtroTipo = document.getElementById('filtro-tipo-coordinador').value
        const filtroFecha = document.getElementById('filtro-fecha-coord').value
        const filas = document.querySelectorAll('.tabla-fichas tbody tr')

        filas.forEach((fila) => {
          const programa = fila.cells[0].textContent.toLowerCase()
          const fecha = fila.getAttribute('data-fecha')
          const tipoNombre = (fila.dataset.tiponombre || '').toLowerCase()
          const tipoId = fila.dataset.tipoid || ''
          const esCampesina = tipoNombre === 'campesina' || tipoId === '2'
          const esRegular = tipoNombre === 'regular' || tipoId === '1'
          let mostrar = true
          // Aplicar los filtros: si filtroPrograma no est√° vac√≠o y no coincide, ocultar
          if (filtroPrograma && !programa.includes(filtroPrograma)) mostrar = false
          if (filtroTipo) {
            const esCampesina = programa.includes('campesina')
            if (filtroTipo === 'Regular' && esCampesina) mostrar = false
            if (filtroTipo === 'Campesina' && !esCampesina) mostrar = false
          }
          if (filtroFecha && fecha !== filtroFecha) mostrar = false
          fila.style.display = mostrar ? '' : 'none'
        })
      }
      function filtrarPorProgramaCoordinador() {
        aplicarFiltrosCoordinador()
      }
      function filtrarPorTipoCoordinador() {
        aplicarFiltrosCoordinador()
      }
      document.getElementById('filtro-fecha-coord').addEventListener('change', aplicarFiltrosCoordinador)
    </script>

  {% else %}
    {% comment %}Mostrar esto solo al Instructor/Administrador{% endcomment %}
    <main class="contenido-principal">
      <!-- T√≠tulo de la secci√≥n -->
      <div class="titulo-seccion">
        <h2 class="titulo-pagina">Consultar solicitudes {{ user }} {{ user_name }}</h2>
        <p class="subtitulo-pagina">Aqu√≠ puede consultar el estado de las fichas solicitadas y descargar los documentos correspondientes</p>
      </div>

      <!-- busqueda y filtro -->
      <!-- filtro por nombre de programa -->
      <div class="filtros-busqueda">
        <div class="filtro-nombre-programa">
          <label for="filtro-programa">Filtrar por Nombre de Programa:</label>
          <input type="text" id="filtro-programa" placeholder="Ingrese el nombre del programa" onkeyup="filtrarPorPrograma()" />
        </div>
        <div class="filtro-tipo-ficha">
          <label for="filtro-tipo">Filtrar por Tipo de Ficha:</label>
          <select id="filtro-tipo" onchange="filtrarPorTipo()">
            <option value="">-- Todos --</option>
            <option value="Regular">Regular</option>
            <option value="Campesina">CampeSENA</option>
          </select>
        </div>
        <div class="filtro-fecha">
          <label for="filtro-fecha-general">Filtrar por Fecha:</label>
          <input type="date" id="filtro-fecha-general" />
        </div>
      </div>

      <!-- Contenedor de la tabla de fichas -->
      <div class="contenedor-tabla-fichas">
        <table class="tabla-fichas">
          <thead>
            <tr>
              <th>Nombre del Programa</th>
              <th>Estado</th>
              <th>Observaci√≥n funcionario</th>
              <th>Ficha de Caracterizaci√≥n</th>
              <th>Cantidad aspirantes Inscritos</th>
              <th>Excel SOF√çA plus</th>
              <th>Fecha de Creaci√≥n</th>
              <th>Compartir</th>
            </tr>
          </thead>
          <tbody>
            {% for solicitud_consulta in solicitudes %}
              <tr data-fecha="{{ solicitud_consulta.fechasolicitud|date:'Y-m-d' }}" data-tipoid="{{ solicitud_consulta.idtiposolicitud.idtiposolicitud }}" data-tiponombre="{{ solicitud_consulta.idtiposolicitud.tiposolicitud }}">
                <td>{{ solicitud_consulta.codigoprograma.nombreprograma }}</td>
                <td>
                  {% if solicitud_consulta.estado_usuario %}
                    <!-- Estado dado por el funcionario -->
                    {% if solicitud_consulta.estado_usuario == 'Matriculada' %}
                      <span class="estado-aprobado">{{ solicitud_consulta.estado_usuario }}</span>
                    {% elif solicitud_consulta.estado_usuario == 'Rechazada' %}
                      <span class="estado-rechazado">{{ solicitud_consulta.estado_usuario }}</span>
                    {% elif solicitud_consulta.estado_usuario == 'Creada' %}
                      <span class="estado-creada">{{ solicitud_consulta.estado_usuario }}</span>
                    {% elif solicitud_consulta.estado_usuario == 'Creacion' %}
                      <span class="estado estado-creacion">{{ solicitud_consulta.estado_usuario }}</span>
                    {% endif %}
                  {% elif solicitud_consulta.estado_coordinador %}
                    <!-- Solo si no hay funcionario, mostrar el del coordinador -->
                    {% if solicitud_consulta.estado_coordinador == 'Aprobada' %}
                      <span class="estado-aprobado">{{ solicitud_consulta.estado_coordinador }}</span>
                    {% elif solicitud_consulta.estado_coordinador == 'Rechazada' %}
                      <span class="estado-rechazado">{{ solicitud_consulta.estado_coordinador }}</span>
                    {% else %}
                      <span class="estado">{{ solicitud_consulta.estado_coordinador }}</span>
                    {% endif %}
                  {% else %}
                    <!-- Si no hay ninguno -->
                    <span class="estado-espera">Lista de espera</span>
                  {% endif %}
                </td>
                <td>
                  {% if solicitud_consulta.observacion_usuario %}
                    {{ solicitud_consulta.observacion_usuario }}
                  {% else %}
                    Sin observaci√≥n
                  {% endif %}
                </td>
                <td>
                  <a href="{% url 'ficha_caracterizacion' solicitud_consulta.idsolicitud %}" class="boton-descargar">Ver ficha Caracterizaci√≥n</a>
                </td>
                <td>
                  {% if solicitud_consulta.aspirantes %}
                    {{ solicitud_consulta.aspirantes|length }} aspirante{{ solicitud_consulta.aspirantes|length|pluralize }}
                  {% else %}
                    Sin aspirantes
                  {% endif %}
                </td>
                <td>
                  {% if solicitud_consulta.estado_usuario in 'Matriculada Rechazada Creacion Creada Lista de espera' and solicitud_consulta.excel_masivo_disponible %}
                    <a href="{% url 'sofia_plus_descarga' solicitud_consulta.idsolicitud %}" class="boton-descargar">Descargar Excel</a>
                  {% else %}
                    <a class="boton-descargar disabled-link" tabindex="-1" aria-disabled="true">Descargar Excel</a>
                  {% endif %}
                </td>
                <td>{{ solicitud_consulta.fechasolicitud }}</td>
                <td>
                  <button onclick="document.getElementById('modal-{{ solicitud_consulta.idsolicitud }}').style.display='block'" class="boton-compartir">Compartir</button>
                </td>
              </tr>

              <!-- Modal √∫nico para cada solicitud -->
              <div id="modal-{{ solicitud_consulta.idsolicitud }}" class="modal-compartir" style="display: none;">
                <div class="contenido-modal">
                  <div class="encabezado-modal">
                    <h3>Compartir Ficha</h3>
                    <button onclick="document.getElementById('modal-{{ solicitud_consulta.idsolicitud }}').style.display='none'" class="boton-cerrar-modal">&times;</button>
                  </div>

                  <div class="cuerpo-modal">
                    <p class="programa-seleccionado">Programa: {{ solicitud_consulta.codigoprograma.nombreprograma }}</p>

                    <!-- Enlace con href correcto -->
                    <div class="opcion-compartir">
                      <h4>Compartir con enlace</h4>
                      <div class="grupo-link">
                        <a href="{% url 'formularioaspirantes' solicitud_consulta.idsolicitud %}">https://preinscripcion/{{ codigo }}</a>
                      </div>
                    </div>

                    <div class="separador-modal">
                      <span>O</span>
                    </div>

                    <!-- Lista de aspirantes -->
                    <div class="opcion-compartir">
                      <h4>Ver aspirantes Inscritos</h4>
                      <div class="resultados-busqueda">
                        {% for aspirante in solicitud_consulta.aspirantes %}
                          <div class="item-aprendiz">
                            <div class="info-aprendiz">
                              <span class="nombre-aprendiz">{{ aspirante.nombre }} {{ aspirante.apellido }}</span>
                              <span class="documento-aprendiz">{{ aspirante.tipoidentificacion.tipoidentificacion }} {{ aspirante.numeroidentificacion }}</span>
                              <span class="documento-aprendiz">Tel√©fono: {{ aspirante.telefono }}</span>
                              <span class="documento-aprendiz">Correo: {{ aspirante.correo }}</span>
                              {% comment %} Ver Pdf de los aspirantes {% endcomment %}
                              <a href="{% url 'seePdfForapplicants' solicitud_consulta.idsolicitud aspirante.numeroidentificacion %}"
                                target="_blank">
                                Ver documento üìÑ
                              </a>
                              <a href="{% url 'editApplicantData' solicitud_consulta.idsolicitud aspirante.numeroidentificacion %}"
                                target="_blank">
                                Editar datos
                              </a>
                              <a href="{%url "removeApplicant" solicitud_consulta.idsolicitud aspirante.numeroidentificacion %}"  target="_blank">
                                Borrar Aspirante
                              </a>
                            </div>
                          </div>
                        {% empty %}
                          <div class="item-aprendiz">
                            <div class="info-aprendiz">
                              <span class="nombre-aprendiz">No hay aspirantes registrados para esta ficha</span>
                            </div>
                          </div>
                        {% endfor %}
                      </div>
                      {% comment %} Botones ver combinado de PDF y excel {% endcomment %}
                      <div>
                          <a href="{% url 'viewCombinedPdf' solicitud_consulta.idsolicitud %}">
                            Ver Pdf combinado üìÑ
                          </a>
                          <a href="{% url 'seeExcelCandidates' solicitud_consulta.idsolicitud %}">
                            Ver Excel
                          </a>
                      </div>
                      <div>
                          {% if solicitud_consulta.revisado == 1 %}
                              <button class="boton-compartir" disabled>
                                  ‚úî Ya revisado
                              </button>
                          {% else %}
                              <form action="{% url 'reviewedByInstructor' solicitud_consulta.idsolicitud %}" method="post">
                                  {% csrf_token %}
                                  <button type="submit" class="boton-compartir">
                                      Revisado
                                  </button>
                              </form>
                          {% endif %}
                      </div>
                    </div>
                  </div>

                  <!-- Pie modal -->
                  <div class="pie-modal">
                    <button onclick="document.getElementById('modal-{{ solicitud_consulta.idsolicitud }}').style.display='none'" class="boton-cancelar">Cancelar</button>
                    <button class="boton-compartir-modal">Compartir</button>
                  </div>
                </div>
              </div>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </main>

    <script>
      // Funciones de filtrado para instructores/administradores
      function filtrarPorPrograma() {
        // Obtener el valor del filtro y las filas de la tabla
        const filtro = document.getElementById('filtro-programa').value.toLowerCase()
        const filas = document.querySelectorAll('.tabla-fichas tbody tr')

        filas.forEach((fila) => {
          const programa = fila.cells[0].textContent.toLowerCase()
          if (programa.includes(filtro)) {
            fila.style.display = ''
          } else {
            fila.style.display = 'none'
          }
        })
      }

      // Filtrar por tipo de ficha (Regular o Campesina)
      function filtrarPorTipo() {
        const filtro = document.getElementById('filtro-tipo').value
        const filas = document.querySelectorAll('.tabla-fichas tbody tr')

        filas.forEach((fila) => {
          const programa = fila.cells[0].textContent
          if (filtro === '') {
            fila.style.display = ''
          } else if (filtro === 'Regular' && esRegular) {
            // si filtro es Regular y la fila es Regular, mostrar
            fila.style.display = ''
          } else if (filtro === 'Campesina' && esCampesina) {
            // si filtro es Campesina y la fila es Campesina, mostrar
            fila.style.display = ''
          } else {
            fila.style.display = 'none'
          }
        })
      }

      // Funci√≥n combinada que aplica ambos filtros
      function aplicarFiltros() {
        // Obtener los valores de los filtros
        const filtroPrograma = document.getElementById('filtro-programa').value.toLowerCase()
        const filtroTipo = document.getElementById('filtro-tipo').value
        const filtroFecha = document.getElementById('filtro-fecha-general').value
        const filas = document.querySelectorAll('.tabla-fichas tbody tr')

        filas.forEach((fila) => {
          const programa = fila.cells[0].textContent.toLowerCase()
          const fecha = fila.getAttribute('data-fecha')
          const tipoNombre = (fila.dataset.tiponombre || '').toLowerCase()
          const tipoId = fila.dataset.tipoid || ''
          const esCampesina = tipoNombre === 'campesina' || tipoId === '2'
          const esRegular = tipoNombre === 'regular' || tipoId === '1'
          let mostrarFila = true

          if (filtroPrograma && !programa.includes(filtroPrograma)) mostrarFila = false
          if (filtroTipo) {
            if (filtroTipo === 'Regular' && !esRegular) mostrarFila = false
            if (filtroTipo === 'Campesina' && !esCampesina) mostrarFila = false
          }
          // Fecha exacta
          if (filtroFecha && fecha !== filtroFecha) mostrarFila = false
          fila.style.display = mostrarFila ? '' : 'none'
        })
      }

      // Actualizar las funciones individuales para usar la funci√≥n combinada
      function filtrarPorPrograma() {
        aplicarFiltros()
      }

      // Actualizar la funci√≥n de filtro por tipo para usar la funci√≥n combinada
      function filtrarPorTipo() {
        aplicarFiltros()
      }

      // Funci√≥n para mostrar alerta si el Excel no est√° disponible
      document.getElementById('filtro-fecha-general').addEventListener('change', aplicarFiltros)
    </script>
  {% endif %}
{% endblock %}
